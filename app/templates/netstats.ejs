<div class="col-lg-12 col-xl-12">

    <div class="page-header">
        <h1 class="page-title">
            Zone Server Netstats
            <div class="small text-muted">
                <span class="zone-name">&nbsp;</span> <span class="zone-port"></span>
            </div>
        </h1>
    </div>

    <!-- Counts -->
    <div class="row row-cards">
        <div class="col-sm-6 col-lg-3">
            <!-- Player count -->
            <div class="card p-3">
                <div class="d-flex align-items-center">
                        <span class="stamp stamp-md bg-red mr-3">
                          <i class="fe fe-users"></i>
                        </span>
                    <div>
                        <h4 class="m-0">
                            <span class="player-count mr-2">0</span>
                            <small>Players</small>
                        </h4>
                        <small class="text-muted">Currently in zone</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-sm-6 col-lg-3">
            <!-- NPC Count -->
            <div class="card p-3">
                <div class="d-flex align-items-center">
                        <span class="stamp stamp-md bg-yellow mr-3">
                          <i class="fe fe-gitlab"></i>
                        </span>
                    <div>
                        <h4 class="m-0"><span class="npc-count">0</span>
                            <small>NPCs</small>
                        </h4>
                        <small class="text-muted">Currently in zone</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Packet Types Sent -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Packet Types Sent from Server</h3>
        </div>
        <div class="card-body">
            <div id="packet-sent-types" style="height: 16rem"></div>
        </div>
    </div>

    <!-- Packet Types Received -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Packet Types Received from Server</h3>
        </div>
        <div class="card-body">
            <div id="packet-receive-types" style="height: 16rem"></div>
        </div>
    </div>

    <!-- Ping -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Ping (ms)</h3>
        </div>
        <div class="card-body">
            <div id="ping" style="height: 8rem"></div>
        </div>
    </div>

    <!-- Packet Loss Inbound -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Packet Loss Inbound %</h3>
        </div>
        <div class="card-body">
            <div id="packet-loss-inbound" style="height: 8rem"></div>
        </div>
    </div>

    <!-- Packet Loss Outbound -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Packet Loss Outbound %</h3>
        </div>
        <div class="card-body">
            <div id="packet-loss-outbound" style="height: 8rem"></div>
        </div>
    </div>

    <!-- Receive bytes per second -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Server Receive (mbps)</h3>
        </div>
        <div class="card-body">
            <div id="receive-bytes" style="height: 8rem"></div>
        </div>
    </div>

    <!-- Sent bytes per second -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Server Sent (mbps)</h3>
        </div>
        <div class="card-body">
            <div id="sent-bytes" style="height: 8rem"></div>
        </div>
    </div>

    <!-- Resent Packets -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Resent Packets</h3>
        </div>
        <div class="card-body">
            <div id="resent-packets" style="height: 8rem"></div>
        </div>
    </div>

    <!-- Resent Fragments -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Resent Fragments</h3>
        </div>
        <div class="card-body">
            <div id="resent-fragments" style="height: 8rem"></div>
        </div>
    </div>

    <!-- Resent Non-Fragments -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Resent Non-Fragments</h3>
        </div>
        <div class="card-body">
            <div id="resent-non-fragments" style="height: 8rem"></div>
        </div>
    </div>

    <!-- Netstats from all clients -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Client Netstats</h3>
            </div>
            <div class="table-responsive">
                <table class="table card-table table-vcenter text-nowrap" id="client-netstats">
                    <thead>
                    <tr>
                        <th>Client ID</th>
                        <th>Client Name</th>
                        <th>Average Ping</th>
                        <th>Last Ping</th>
                        <th>Min Ping</th>
                        <th>Max Ping</th>
                        <th>Packet Loss In %</th>
                        <th>Packet Loss Out %</th>
                        <th>Realtime Receive Packets</th>
                        <th>Realtime Sent Packets</th>
                        <th>Receive bps</th>
                        <th>Sent bps</th>
                        <th>Resent Packets</th>
                        <th>Resent Fragments</th>
                        <th>Resent Non Fragments</th>
                        <th>Seconds Since Reset</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td></td>
                        <td></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="text/javascript">
      netstat_zone_port = <%= port %>;

      var npc_list    = [];
      var client_list = [];

      require(['c3'], function (c3) {
        $('.zone-port').html("Port: " + netstat_zone_port);

        $(document).ready(function () {

          getClientNetstats();

          /**
           * Zone attributes
           * @type {string}
           */
          $.get('/api/zoneserver/' + netstat_zone_port + '/attributes', function (data) {
            $(".zone-name").html(data[0].long_name + " (" + data[0].short_name + ")");
          });

          /**
           * Client details
           * @type {string}
           */
          $.get('/api/zoneserver/' + netstat_zone_port + '/client/list/detail', function (data) {
            // console.log(data);
            $(".player-count").html(data.length);
            client_list = data;
          });

          /**
           * NPC details
           * @type {string}
           */
          $.get('/api/zoneserver/' + netstat_zone_port + '/npc/list/detail', function (data) {
            // console.log(data);
            $(".npc-count").html(data.length);
            npc_list = data;
          });

          var chart_base_config = {
            bindto: '#packet-loss-inbound',
            transition: {
              duration: 0
            },
            point: {
              show: false
            },
            line: {
              connectNull: true,
            },
            data: {},
            legend: {
              show: false
            },
            axis: {
              x: {
                type: 'timeseries',
                tick: {
                  format: '%H:%M:%S',
                  fit: true,
                }
              },
              y: {
                show: true
              }
            }
          };

          /**
           * Initialize Charts
           * @type {string}
           */
          var chart_endpoint = '/api/zoneserver/netstat/' + netstat_zone_port + '/chart';
          $.get(chart_endpoint, function (data) {
            chart_packet_types_sent = c3.generate(
              $.extend(chart_base_config, {
                  bindto: "#packet-sent-types",
                  data: data.sent_packet_types
                }
              ));

            chart_packet_types_receive = c3.generate(
              $.extend(chart_base_config, {
                  bindto: "#packet-receive-types",
                  data: data.receive_packet_types
                }
              ));

            chart_ping = c3.generate(
              $.extend(chart_base_config, {
                  bindto: "#ping",
                  data: data.ping
                }
              ));

            chart_packet_loss_inbound = c3.generate(
              $.extend(chart_base_config, {
                  bindto: "#packet-loss-inbound",
                  data: data.packet_loss_inbound
                }
              ));

            chart_packet_loss_outbound = c3.generate(
              $.extend(chart_base_config, {
                  bindto: "#packet-loss-outbound",
                  data: data.packet_loss_outbound
                }
              ));

            chart_receive_bytes = c3.generate(
              $.extend(chart_base_config, {
                  bindto: "#receive-bytes",
                  data: data.receive_bytes
                }
              ));

            chart_sent_bytes = c3.generate(
              $.extend(chart_base_config, {
                  bindto: "#sent-bytes",
                  data: data.sent_bytes
                }
              ));

            chart_resent_packets = c3.generate(
              $.extend(chart_base_config, {
                  bindto: "#resent-packets",
                  data: data.resent_packets
                }
              ));

            chart_resent_fragments = c3.generate(
              $.extend(chart_base_config, {
                  bindto: "#resent-fragments",
                  data: data.resent_fragments
                }
              ));

            chart_resent_non_fragments = c3.generate(
              $.extend(chart_base_config, {
                  bindto: "#resent-non-fragments",
                  data: data.resent_non_fragments
                }
              ));
          });

          /**
           * Refresh charts
           */
          function refreshCharts() {
            $.get(chart_endpoint, function (data) {
              chart_packet_types_sent.load(data.sent_packet_types);
              chart_packet_types_receive.load(data.receive_packet_types);
              chart_ping.load(data.ping);
              chart_packet_loss_inbound.load(data.packet_loss_inbound);
              chart_packet_loss_outbound.load(data.packet_loss_outbound);
              chart_receive_bytes.load(data.receive_bytes);
              chart_sent_bytes.load(data.sent_bytes);
              chart_resent_packets.load(data.resent_packets);
              chart_resent_fragments.load(data.resent_fragments);
              chart_resent_non_fragments.load(data.resent_non_fragments);
            });
          }

          setInterval(function () {
            refreshCharts();
            getClientNetstats();
          }, 5000);

          /**
           * Client netstats
           */
          function getClientNetstats() {
            $.get('/api/zoneserver/' + netstat_zone_port + '/netstats', function (data) {

              /**
               * Update table
               */
              $('#client-netstats tbody').empty();

              for (var row in data) {

                var client_stats = [
                  data[row].client_id,
                  data[row].client_name,
                  commify(data[row].average_ping) + " ms",
                  commify(data[row].last_ping) + " ms",
                  commify(data[row].min_ping) + " ms",
                  commify(data[row].max_ping) + " ms",
                  parseFloat(data[row].packet_loss_in).toFixed(2),
                  parseFloat(data[row].packet_loss_out).toFixed(2),
                  commify(data[row].realtime_receive_packets),
                  commify(data[row].realtime_sent_packets),
                  parseFloat(data[row].receive_bytes / data[row].seconds_since_reset).toFixed(1) + " bps",
                  parseFloat(data[row].sent_bytes / data[row].seconds_since_reset).toFixed(1) + " bps",
                  commify(data[row].resent_packets),
                  commify(data[row].resent_fragments),
                  commify(data[row].resent_non_fragments),
                  parseFloat(data[row].seconds_since_reset).toFixed(2),
                ];

                var row_data = "";
                for (var stat in client_stats) {
                  row_data = row_data + "<td>" + client_stats[stat] + "</td>";
                }

                $("#client-netstats > tbody").append('<tr>' + row_data + '</tr>');
              }
            });
          }

          function commify(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
          }

        });
      });
    </script>
</div>
